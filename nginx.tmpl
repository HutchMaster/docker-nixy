# Example template of how to use Nginx to load balance TCP and UDP.
worker_processes auto;
pid /var/run/nginx.pid;
user root;

events {
    use epoll;
    worker_connections 10000;
}
stream {
        log_format basic '$remote_addr [$time_local] '
                    '$protocol $status $bytes_sent $bytes_received '
                    '$session_time' '$sessionPort';
        js_include stream.js;

        js_set $sessionPort getSessionPort;

        upstream udp_upstreams {
            server 10.32.0.4:10500;
            server 10.32.0.5:10500;
            server 10.32.0.6:10500;
            server 10.32.0.7:10500;
            server 10.32.0.8:10500;
            server 10.32.0.9:10500;
            server 10.32.0.10:10500;
            server 10.32.0.11:10500;
            server 10.32.0.12:10500;
            server 10.32.0.13:10500;
            server 10.32.0.14:10500;
            server 10.32.0.15:10500;
            server 10.32.0.16:10500;
            server 10.32.0.17:10500;
            server 10.32.0.18:10500;
            server 10.32.0.19:10500;
            server 10.32.0.20:10500;
            server 10.32.0.21:10500;
            server 10.32.0.22:10500;
            server 10.32.0.23:10500;
            server 10.32.0.24:10500;
            server 10.32.0.25:10500;
            server 10.32.0.26:10500;
            server 10.32.0.27:10500;
            server 10.32.0.28:10500;
            server 10.32.0.29:10500;
            server 10.32.0.30:10500;
            server 10.32.0.31:10500;
            server 10.32.0.32:10500;
            server 10.32.0.33:10500;
            server 10.32.0.34:10500;
            server 10.32.0.35:10500;
            server 10.32.0.36:10500;
            server 10.32.0.37:10500;
            server 10.32.0.38:10500;
            server 10.32.0.39:10500;
            server 10.32.0.40:10500;
            server 10.32.0.41:10500;
            server 10.32.0.42:10500;
            server 10.32.0.43:10500;
            server 10.32.0.44:10500;
            server 10.32.0.45:10500;
            server 10.32.0.46:10500;
            server 10.32.0.47:10500;
            server 10.32.0.48:10500;
            server 10.32.0.49:10500;
            server 10.32.0.50:10500;
            server 10.32.0.51:10500;
            server 10.32.0.52:10500;
            server 10.32.0.53:10500;
            server 10.32.0.54:10500;
            server 10.32.0.55:10500;
            server 10.32.0.56:10500;
            server 10.32.0.57:10500;
            server 10.32.0.58:10500;
            server 10.32.0.59:10500;
            server 10.32.0.60:10500;
            server 10.32.0.61:10500;
            server 10.32.0.62:10500;
            server 10.32.0.63:10500;
            server 10.32.0.64:10500;
            server 10.32.0.65:10500;
            server 10.32.0.66:10500;
            server 10.32.0.67:10500;
            server 10.32.0.68:10500;
            server 10.32.0.69:10500;
            server 10.32.0.70:10500;
            server 10.32.0.71:10500;
            server 10.32.0.72:10500;
            server 10.32.0.73:10500;
            server 10.32.0.74:10500;
            server 10.32.0.75:10500;
            server 10.32.0.76:10500;
            server 10.32.0.77:10500;
            server 10.32.0.78:10500;
            server 10.32.0.79:10500;
            server 10.32.0.80:10500;
            server 10.32.0.81:10500;
            server 10.32.0.82:10500;
            server 10.32.0.83:10500;
            server 10.32.0.84:10500;
            server 10.32.0.85:10500;
            server 10.32.0.86:10500;
            server 10.32.0.87:10500;
            server 10.32.0.88:10500;
            server 10.32.0.89:10500;
            server 10.32.0.90:10500;
            server 10.32.0.91:10500;
            server 10.32.0.92:10500;
            server 10.32.0.93:10500;
            server 10.32.0.94:10500;
            server 10.32.0.95:10500;
            server 10.32.0.96:10500;
            server 10.32.0.97:10500;
            server 10.32.0.98:10500;
            server 10.32.0.99:10500;
            server 10.32.0.100:10500;
            server 10.32.0.101:10500;
            server 10.32.0.102:10500;
            server 10.32.0.103:10500;
            server 10.32.0.104:10500;
            server 10.32.0.105:10500;
            server 10.32.0.106:10500;
            server 10.32.0.107:10500;
            server 10.32.0.108:10500;
            server 10.32.0.109:10500;
            server 10.32.0.110:10500;
            server 10.32.0.111:10500;
            server 10.32.0.112:10500;
            server 10.32.0.113:10500;
            server 10.32.0.114:10500;
            server 10.32.0.115:10500;
            server 10.32.0.116:10500;
            server 10.32.0.117:10500;
            server 10.32.0.118:10500;
            server 10.32.0.119:10500;
            server 10.32.0.120:10500;
            server 10.32.0.121:10500;
            server 10.32.0.122:10500;
            server 10.32.0.123:10500;
            server 10.32.0.124:10500;
            server 10.32.0.125:10500;
            server 10.32.0.126:10500;
            server 10.32.0.127:10500;
            server 10.32.0.128:10500;
            server 10.32.0.129:10500;
            server 10.32.0.130:10500;
            server 10.32.0.131:10500;
            server 10.32.0.132:10500;
            server 10.32.0.133:10500;
            server 10.32.0.134:10500;
            server 10.32.0.135:10500;
            server 10.32.0.136:10500;
            server 10.32.0.137:10500;
            server 10.32.0.138:10500;
            server 10.32.0.139:10500;
            server 10.32.0.140:10500;
            server 10.32.0.141:10500;
            server 10.32.0.142:10500;
            server 10.32.0.143:10500;
            server 10.32.0.144:10500;
            server 10.32.0.145:10500;
            server 10.32.0.146:10500;
            server 10.32.0.147:10500;
            server 10.32.0.148:10500;
            server 10.32.0.149:10500;
            server 10.32.0.150:10500;
            server 10.32.0.151:10500;
            server 10.32.0.152:10500;
            server 10.32.0.153:10500;
            server 10.32.0.154:10500;
            server 10.32.0.155:10500;
            server 10.32.0.156:10500;
            server 10.32.0.157:10500;
            server 10.32.0.158:10500;
            server 10.32.0.159:10500;
            server 10.32.0.160:10500;
            server 10.32.0.161:10500;
            server 10.32.0.162:10500;
            server 10.32.0.163:10500;
            server 10.32.0.164:10500;
            server 10.32.0.165:10500;
            server 10.32.0.166:10500;
            server 10.32.0.167:10500;
            server 10.32.0.168:10500;
            server 10.32.0.169:10500;
            server 10.32.0.170:10500;
            server 10.32.0.171:10500;
            server 10.32.0.172:10500;
            server 10.32.0.173:10500;
            server 10.32.0.174:10500;
            server 10.32.0.175:10500;
            server 10.32.0.176:10500;
            server 10.32.0.177:10500;
            server 10.32.0.178:10500;
            server 10.32.0.179:10500;
            server 10.32.0.180:10500;
            server 10.32.0.181:10500;
            server 10.32.0.182:10500;
            server 10.32.0.183:10500;
            server 10.32.0.184:10500;
            server 10.32.0.185:10500;
            server 10.32.0.186:10500;
            server 10.32.0.187:10500;
            server 10.32.0.188:10500;
            server 10.32.0.189:10500;
            server 10.32.0.190:10500;
            server 10.32.0.191:10500;
            server 10.32.0.192:10500;
            server 10.32.0.193:10500;
            server 10.32.0.194:10500;
            server 10.32.0.195:10500;
            server 10.32.0.196:10500;
            server 10.32.0.197:10500;
            server 10.32.0.198:10500;
            server 10.32.0.199:10500;
            server 10.32.0.200:10500;
            server 10.32.0.201:10500;
            server 10.32.0.202:10500;
            server 10.32.0.203:10500;
            server 10.32.0.204:10500;
            server 10.32.0.205:10500;
            server 10.32.0.206:10500;
            server 10.32.0.207:10500;
            server 10.32.0.208:10500;
            server 10.32.0.209:10500;
            server 10.32.0.210:10500;
            server 10.32.0.211:10500;
            server 10.32.0.212:10500;
            server 10.32.0.213:10500;
            server 10.32.0.214:10500;
            server 10.32.0.215:10500;
            server 10.32.0.216:10500;
            server 10.32.0.217:10500;
            server 10.32.0.218:10500;
            server 10.32.0.219:10500;
            server 10.32.0.220:10500;
            server 10.32.0.221:10500;
            server 10.32.0.222:10500;
            server 10.32.0.223:10500;
            server 10.32.0.224:10500;
            server 10.32.0.225:10500;
            server 10.32.0.226:10500;
            server 10.32.0.227:10500;
            server 10.32.0.228:10500;
            server 10.32.0.229:10500;
            server 10.32.0.230:10500;
            server 10.32.0.231:10500;
            server 10.32.0.232:10500;
            server 10.32.0.233:10500;
            server 10.32.0.234:10500;
            server 10.32.0.235:10500;
            server 10.32.0.236:10500;
            server 10.32.0.237:10500;
            server 10.32.0.238:10500;
            server 10.32.0.239:10500;
            server 10.32.0.240:10500;
            server 10.32.0.241:10500;
            server 10.32.0.242:10500;
            server 10.32.0.243:10500;
            server 10.32.0.244:10500;
            server 10.32.0.245:10500;
            server 10.32.0.246:10500;
            server 10.32.0.247:10500;
            server 10.32.0.248:10500;
            server 10.32.0.249:10500;
            server 10.32.0.250:10500;
            server 10.32.0.251:10500;
            server 10.32.0.252:10500;
            server 10.32.0.253:10500;
            server 10.32.0.254:10500;
            server 10.32.0.255:10500;
        }

        map $sessionPort $server_choice {
        {{- range $appid, $app := .Apps}}
        {{- range $label, $label := $app.Labels}}
        {{- if eq $label "UDPLoadBalanced"  }}
        {{- range $index, $task := $app.Tasks}}
            {{- $ip := split $task.Host "."}}
            {{index $ip 3}}{{ index $task.Ports 1 }} 10.32.0.{{ index $ip 3 }}:{{ index $task.Ports 1 }};
        {{- end}}
        {{- end}}
        {{- end}}
        {{- end}}
        }

    server {
        listen 10500 udp reuseport;
        proxy_timeout 1s;
        proxy_pass $server_choice;
        #proxy_bind $remote_addr:$remote_port transparent;
    }
}